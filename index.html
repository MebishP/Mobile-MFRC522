<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BLE Terminal with Fallback Service</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #log {
            width: 100%;
            height: 200px;
            border: 1px solid #ccc;
            padding: 10px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        input, button { margin: 5px; padding: 8px; }
    </style>
</head>
<body>
    <h2>BLE Terminal with Fallback Service</h2>
    <div id="status"></div>
    <button id="connect">Connect to Device</button>
    <button id="disconnect" disabled>Disconnect</button>
    <br>
    <textarea id="log" readonly></textarea>
    <br>
    <input type="text" id="command" placeholder="Enter command">
    <button id="send" disabled>Send</button>

    <script>
        let device = null;
        let server = null;
        let service = null;
        let writeCharacteristic = null;
        let notifyCharacteristic = null;
        let uartServiceFound = false;

        const statusDiv = document.getElementById("status");
        const logArea = document.getElementById("log");
        const connectButton = document.getElementById("connect");
        const disconnectButton = document.getElementById("disconnect");
        const sendButton = document.getElementById("send");
        const commandInput = document.getElementById("command");

        function logMessage(message) {
            logArea.value += message + "\n";
            logArea.scrollTop = logArea.scrollHeight;
        }

        function resetVariables() {
            device = null;
            server = null;
            service = null;
            writeCharacteristic = null;
            notifyCharacteristic = null;
            uartServiceFound = false;
        }

        async function connect() {
            if (!navigator.bluetooth) {
                statusDiv.textContent = "Web Bluetooth API is not available in this browser.";
                return;
            }
            try {
                device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
                });
                statusDiv.textContent = "Connecting...";
                server = await device.gatt.connect();

                try {
                    service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');
                    uartServiceFound = true;
                    writeCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');
                    notifyCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');
                    await notifyCharacteristic.startNotifications();
                    notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                    logMessage("Connected with expected UART service.");
                    sendButton.disabled = false;
                } catch (uartError) {
                    logMessage("UART service not found. Attempting fallback...");
                    let services = await server.getPrimaryServices();
                    let fallbackFound = false;
                    for (const s of services) {
                        try {
                            let characteristics = await s.getCharacteristics();
                            for (const c of characteristics) {
                                if (c.properties.write || c.properties.writeWithoutResponse) {
                                    writeCharacteristic = c;
                                    for (const nc of characteristics) {
                                        if (nc.properties.notify) {
                                            notifyCharacteristic = nc;
                                            try {
                                                await notifyCharacteristic.startNotifications();
                                                notifyCharacteristic.addEventListener('characteristicvaluechanged', handleNotifications);
                                            } catch (notifyError) {
                                                console.log("Notify setup error: " + notifyError);
                                            }
                                            break;
                                        }
                                    }
                                    fallbackFound = true;
                                    break;
                                }
                            }
                        } catch (innerError) {
                            console.log("Error accessing service: " + innerError);
                        }
                        if (fallbackFound) {
                            break;
                        }
                    }
                    if (fallbackFound) {
                        logMessage("Fallback service found. Send enabled.");
                        sendButton.disabled = false;
                    } else {
                        logMessage("No writable service found. Send disabled.");
                        sendButton.disabled = true;
                    }
                }

                disconnectButton.disabled = false;
                device.addEventListener('gattserverdisconnected', onDisconnected);
                statusDiv.textContent = "Connected";
            } catch (error) {
                logMessage("Connection failed: " + error);
                statusDiv.textContent = "Connection failed";
                resetVariables();
            }
        }

        function onDisconnected() {
            logMessage("Disconnected from device");
            statusDiv.textContent = "Disconnected";
            sendButton.disabled = true;
            disconnectButton.disabled = true;
            resetVariables();
        }

        function handleNotifications(event) {
            const value = event.target.value;
            const decoder = new TextDecoder('utf-8');
            const text = decoder.decode(value);
            logMessage("Received: " + text);
        }

        async function disconnect() {
            if (device && device.gatt.connected) {
                device.gatt.disconnect();
            } else {
                logMessage("No device connected");
            }
        }

        async function sendCommand() {
            if (!writeCharacteristic) {
                logMessage("Writable characteristic not available; cannot send command.");
                return;
            }
            const command = commandInput.value;
            if (!command) {
                logMessage("Please enter a command");
                return;
            }
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(command + "\n");
                await writeCharacteristic.writeValue(data);
                logMessage("Sent: " + command);
            } catch (error) {
                logMessage("Failed to send command: " + error);
            }
        }

        connectButton.addEventListener("click", connect);
        disconnectButton.addEventListener("click", disconnect);
        sendButton.addEventListener("click", sendCommand);
    </script>
</body>
</html>
